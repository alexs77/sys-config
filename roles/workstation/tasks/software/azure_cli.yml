- name: software | azure cli | add repository key
  tags: packages,azure-cli,workstation-packages
  ansible.builtin.apt_key:
    url: https://packages.microsoft.com/keys/microsoft.asc
  when:
    - ansible_os_family == "Debian"
    - azure_cli is defined
    - azure_cli == true

- name: software | azure cli | add repository (Debian family, not Ubuntu Impish)
  tags: packages,azure-cli,workstation-packages
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ {{ ansible_distribution_release }} main"
    filename: azure-cli
  register: azure_cli_repo
  when:
    - ansible_os_family == "Debian"
    - ansible_distribution_release != "impish"
    - azure_cli is defined
    - azure_cli == true

# At 2021-11-28, there was no repo for Impish (21.10), only for Hirsute (21.04)
- name: software | azure cli | add repository (Ubuntu Impish)
  tags: packages,azure-cli,workstation-packages
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ hirsute main"
    filename: azure-cli
  register: azure_cli_repo
  when:
    - ansible_distribution_release == "impish"
    - azure_cli is defined
    - azure_cli == true

- name: software | azure cli | update sources (repo added or changed)
  tags: packages,azure-cli,workstation-packages
  ansible.builtin.apt:
    update_cache: yes
  changed_when: false
  when:
    - ansible_os_family == "Debian"
    - azure_cli is defined
    - azure_cli == true
    - azure_cli_repo.changed

- name: software | azure cli | install package
  tags: packages,azure-cli,workstation-packages
  ansible.builtin.apt:
    name: azure-cli
  when:
    - ansible_os_family == "Debian"
    - azure_cli is defined
    - azure_cli == true
